---
layout: post
title: How to use Bootstrap 3 validation states with ASP.NET MVC Forms
categories:
- programming
tags:
- asp.net mvc
- c#
status: publish
type: post
published: true
---
Recently, when writing code for my blog post on drop downs, "[DropDownListFor with Dictionaries in
ASP.NET MVC and why SelectList wants to kill you][1]", I stumbled over an interesting problem --
when using ASP.NET MVC HTML helpers, such as `@Html.TextBoxFor()` and `@Html.DropDownListFor()` to
render controls and `@Html.ValidationMessageFor()` to render validation error messages, I realised
that ASP.NET MVC uses its own CSS classes, so no errors are getting highlighted when using Bootstrap
3.

There's nothing wrong with MVC as such in here, as it is meant to be CSS framework agnostic, meaning
you should be able to use it with any CSS framework.

## Problem
To get better understanding of the problem, have a look at this HTML that's generated by MVC on
postback. It contains an error message for a required text field.

{% highlight html %}
<div class="form-group">

    <label for="FirstName">First name</label>

    <input class="input-validation-error form-control" data-val="true"
           data-val-required="The First name field is required."
           id="FirstName" name="FirstName" type="text" value="">

    <span class="field-validation-error" data-valmsg-for="FirstName"
          data-valmsg-replace="true">The First name field is required.</span>
</div>
{% endhighlight %}

As you can see, ASP.NET uses its own CSS classes, such as `input-validation-error` (used to
highlight control with an invalid value) and `field-validation-error` which contains explanatory
text for the error.

Without proper styling the above HTML looks like this:

<p class="center" markdown="1">
    ![No styling on the control][2]
</p>

Not too bad, but could be better. Bootstrap 3 has this awesome indication for invalid form controls,
and it hightlights the entire control and the error text:

<p class="center" markdown="1">
    ![Like a boss][3]
</p>

So following [Bootstrap's own documentation][4] we need to make sure that control with error has a
parent with the class of `has-error` and the validation error message element needs to have the
class of `text-danger`. That's how HTML needs to look like to get proper error highlighting:

{% highlight html %}
<div class="has-error form-group"> <!-- 'has-error' class has been added on parent form-group div -->

    <label for="FirstName">First name</label>

    <input class="input-validation-error form-control" data-val="true"
           data-val-required="The First name field is required."
           id="FirstName" name="FirstName" type="text" value="">

    <!-- 'text-danger' has been added on the span with validation error message -->
    <span class="text-danger field-validation-error" data-valmsg-for="FirstName"
          data-valmsg-replace="true">The First name field is required.</span>
</div>
{% endhighlight %}

<script>
  // Hacky hack to highlight changes in HTML
  (function($) {
    $('span.s:contains("has-error form-group")').html('"<strong>has-error</strong> form-group"');
    $('span.s:contains("text-danger field-validation-error")').html('"<strong>text-danger</strong> field-validation-error"');
  })(jQuery);
</script>

## Solution
It is clear that we just need to add two puny CSS classes, but how exactly this is done depends on
whether you use client-side JavaScript validation or not.

## No client-side validation
If your form is submitted to the server with no prior on-the-client JavaScript validation (old
school! but it works), then you've got yourself the easiest of all fixed. You can just add these CSS
classes whenever the page loads in the following fashion:

{% highlight javascript %}
$(document).ready(function() {
    $('.input-validation-error').parents('.form-group').addClass('has-error');
    $('.field-validation-error').addClass('text-danger');
});
{% endhighlight %}

## ASP.NET MVC Unobtrusive validation
Most likely though you're using in-built ASP.NET MVC's own [unobtrusive jQuery validation][5], in
which case we need to hook into `success` and `errorPlacement` events of the [jQuery Validation
Plugin][6]:

{% highlight javascript %}
$(document).ready(function () {
    var form = $('#userForm')
        , formData = $.data(form[0])
        , settings = formData.validator.settings
        // Store existing event handlers in local variables
        , oldErrorPlacement = settings.errorPlacement
        , oldSuccess = settings.success;

    settings.errorPlacement = function(label, element) {

        // Call old handler so it can update the HTML
        oldErrorPlacement(label, element);

        // Add Bootstrap classes to newly added elements
        label.parents('.form-group').addClass('has-error');
        label.addClass('text-danger');
    };

    settings.success = function(label) {
        // Remove error class from <div class="form-group">, but don't worry about
        // validation error messages as the plugin is going to remove it anyway
        label.parents('.form-group').removeClass('has-error');

        // Call old handler to do rest of the work
        oldSuccess(label);
    };
});
{% endhighlight %}

Now admittedly this is a tad hacky, I personally don't like how our validation code assumes a number
of dangerous things, such as knowledge of parameter lists for internal functions, but it works.

## Fluent Validation
[FluentValidation][7] is another popular library for ASP.NET MVC, and given it integrates with
standard validation, you can use solutions listed above to make it work.

## DID IT HELP? GET SOME MORE!
You can get the source code for the examples used in this article here as a [Zip archive][8] or [browse
the code][9] on github.

Subscribe to my mailing list to get handy tips on working with the framework, various libraries and all sort of surrounding stuff.

{% include subscription.html %}

[1]:{% post_url 2015-01-06-dropdownlistfor-with-dictionaries-in-ASP-NET-MVC-and-why-SelectList-wants-to-kill-you %}
[2]:/img/mvc/bootstrap3/no-style.png
[3]:/img/mvc/bootstrap3/like-a-boss.png
[4]:http://getbootstrap.com/css/#forms-control-validation
[5]:https://www.nuget.org/packages/jQuery.Validation.Unobtrusive/
[6]:http://jqueryvalidation.org/documentation
[7]:https://fluentvalidation.codeplex.com
[8]:https://github.com/ArtS/aspnetmvc-validation/archive/master.zip
[9]:https://github.com/ArtS/aspnetmvc-validation
